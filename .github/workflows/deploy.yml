name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20.11.1'

    - name: Set environment variables
      run: |
        echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> $GITHUB_ENV
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
        echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> $GITHUB_ENV
        echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "GOOGLE_TTS_KEY=${{ secrets.GOOGLE_TTS_KEY }}" >> $GITHUB_ENV
        echo "PORT=${{ secrets.PORT }}" >> $GITHUB_ENV

    - name: Create .env file
      run: |
        echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" > .env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
        echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> .env
        echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> .env
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
        echo "GOOGLE_TTS_KEY=${{ secrets.GOOGLE_TTS_KEY }}" >> .env
        echo "PORT=${{ secrets.PORT }}" >> .env
        cat .env 

    - name: Create SSH key file
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/sodam-ec2-deploy-pipe1.pem
        chmod 400 /tmp/sodam-ec2-deploy-pipe1.pem

    - name: Get GitHub Actions IP range
      run: |
        curl https://api.github.com/meta | jq -r '.actions[]' > github-actions-ip-ranges.txt
        cat github-actions-ip-ranges.txt

    - name: Update AWS security group
      run: |
        aws ec2 authorize-security-group-ingress --group-id sg-0b3e997b2a1c72139 \
          --protocol tcp --port 22 --cidr $(cat github-actions-ip-ranges.txt)

    - name: Transfer .env file to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i /tmp/sodam-ec2-deploy-pipe1.pem .env ubuntu@3.36.127.254:/home/ubuntu/Sodam/.env


    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i /tmp/sodam-ec2-deploy-pipe1.pem ubuntu@3.36.127.254  <<EOF
          cd /home/ubuntu/Sodam
          git pull origin main
          npm install
          pm2 restart all
        EOF
